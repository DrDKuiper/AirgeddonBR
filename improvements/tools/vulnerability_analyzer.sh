#!/usr/bin/env bash

################################################################################
# Airgeddon Vulnerability Analyzer
# Analyzes WiFi networks for common security vulnerabilities
# Version: 1.0
# Usage: source vulnerability_analyzer.sh
################################################################################

source "$(dirname "${BASH_SOURCE[0]}")/logging.sh"

# Vulnerability database
declare -gA VULN_DATABASE=(
    ["WEP"]="Extremely weak encryption, deprecated"
    ["WPA_MIXED"]="WPA/WPA2 mixed mode allows downgrade attacks"
    ["WPA_TKIP"]="TKIP encryption is weak, use CCMP instead"
    ["NO_ENCRYPTION"]="Network is completely unencrypted"
    ["WPS_ENABLED"]="WPS enabled, vulnerable to brute force attacks"
    ["SHORT_PASSWORD"]="Password too short, easily crackable"
    ["COMMON_PASSWORD"]="Password appears in common password lists"
    ["OUTDATED_FIRMWARE"]="Device firmware appears outdated"
    ["HIDDEN_SSID"]="Hidden SSID provides false sense of security"
    ["DEFAULT_CREDENTIALS"]="Device likely uses default credentials"
)

# Risk scoring parameters
readonly RISK_FACTOR_CRITICAL=25
readonly RISK_FACTOR_HIGH=15
readonly RISK_FACTOR_MEDIUM=8
readonly RISK_FACTOR_LOW=3

###############################################################################
# Analyze encryption type and return vulnerability assessment
# Arguments: $1 - Encryption type (WEP|WPA|WPA2|WPA3|Open)
# Returns: Vulnerability severity (CRITICAL|HIGH|MEDIUM|LOW|NONE)
###############################################################################
analyze_encryption() {
    local encryption="${1,,}"
    
    case "${encryption}" in
        open|none|"")
            log_warn "No encryption detected"
            echo "CRITICAL"
            ;;
        wep)
            log_error "WEP encryption detected - deprecated and vulnerable"
            echo "CRITICAL"
            ;;
        wpa-tkip|wpa_tkip)
            log_error "WPA with TKIP detected - vulnerable to key recovery attacks"
            echo "HIGH"
            ;;
        wpa|wpa-psk|wpa_psk)
            log_warn "WPA (PSK) detected - older than WPA2"
            echo "MEDIUM"
            ;;
        wpa2|wpa2-psk|wpa2_psk)
            log_info "WPA2 detected - secure if password is strong"
            echo "LOW"
            ;;
        wpa3|wpa3-psk|wpa3_psk)
            log_info "WPA3 detected - most secure option"
            echo "NONE"
            ;;
        wpa2/wpa3|wpa3/wpa2|"wpa2-wpa3 mixed"|"wpa3-wpa2 mixed")
            log_info "WPA2/WPA3 mixed mode detected"
            echo "LOW"
            ;;
        *)
            log_warn "Unknown encryption type: ${encryption}"
            echo "MEDIUM"
            ;;
    esac
}

###############################################################################
# Assess password strength based on length and complexity
# Arguments: $1 - Password string
# Returns: Severity level (LOW|MEDIUM|HIGH|CRITICAL)
###############################################################################
assess_password_strength() {
    local password="$1"
    local length=${#password}
    
    # Check minimum length
    if [[ ${length} -lt 8 ]]; then
        log_error "Password too short (${length} characters, minimum 12 recommended)"
        echo "HIGH"
        return
    fi
    
    if [[ ${length} -lt 12 ]]; then
        log_warn "Password is relatively short (${length} characters)"
        echo "MEDIUM"
        return
    fi
    
    # Check character variety
    local has_lower=0 has_upper=0 has_digit=0 has_special=0
    
    [[ "${password}" =~ [a-z] ]] && has_lower=1
    [[ "${password}" =~ [A-Z] ]] && has_upper=1
    [[ "${password}" =~ [0-9] ]] && has_digit=1
    [[ "${password}" =~ [^a-zA-Z0-9] ]] && has_special=1
    
    local complexity=$((has_lower + has_upper + has_digit + has_special))
    
    if [[ ${complexity} -lt 3 ]]; then
        log_warn "Password lacks character variety (uses only $complexity character types)"
        echo "MEDIUM"
    elif [[ ${complexity} -eq 4 ]]; then
        log_info "Password appears strong"
        echo "LOW"
    else
        echo "LOW"
    fi
}

###############################################################################
# Check if BSSID/MAC is in common/vulnerable device list
# Arguments: $1 - MAC address/BSSID
###############################################################################
check_device_vulnerability() {
    local bssid="${1^^}"
    local oui="${bssid:0:8}"
    
    # Common vulnerable device patterns (OUI prefixes)
    declare -a VULNERABLE_DEVICES=(
        "00:1A:2A"  # TP-Link common vulnerability
        "88:51:FB"  # TP-Link WPS vulnerability
        "C0:A8:00"  # Netgear default credentials
        "00:0B:85"  # Realtek common issues
    )
    
    for device in "${VULNERABLE_DEVICES[@]}"; do
        if [[ "${oui}" == "${device}"* ]]; then
            log_warn "BSSID ${bssid} matches known vulnerable device pattern"
            echo "HIGH"
            return 0
        fi
    done
    
    echo "NONE"
}

###############################################################################
# Analyze signal strength and determine detection risk
# Arguments: $1 - Signal strength in dBm (negative number, e.g., -45)
###############################################################################
analyze_signal_strength() {
    local signal=${1}
    
    # Convert to positive number for easier comparison
    local strength=$((0 - signal))
    
    if [[ ${strength} -le 30 ]]; then
        log_info "Signal strength excellent (${signal} dBm) - device may be physically close"
        echo "EXCELLENT"
    elif [[ ${strength} -le 50 ]]; then
        log_info "Signal strength good (${signal} dBm)"
        echo "GOOD"
    elif [[ ${strength} -le 70 ]]; then
        log_info "Signal strength fair (${signal} dBm)"
        echo "FAIR"
    elif [[ ${strength} -le 90 ]]; then
        log_warn "Signal strength weak (${signal} dBm)"
        echo "WEAK"
    else
        log_warn "Signal strength very weak/borderline (${signal} dBm)"
        echo "VERY_WEAK"
    fi
}

###############################################################################
# Calculate overall risk score for a network
# Arguments:
#   $1 - BSSID
#   $2 - Encryption
#   $3 - Signal strength
#   $4 - WPS enabled (yes/no)
#   $5 - Hidden SSID (yes/no)
###############################################################################
calculate_risk_score() {
    local bssid="$1"
    local encryption="$2"
    local signal="${3:--50}"
    local wps_enabled="${4:-no}"
    local hidden_ssid="${5:-no}"
    
    local risk_score=0
    
    log_debug "Calculating risk score for ${bssid}"
    
    # Encryption vulnerabilities
    local enc_severity=$(analyze_encryption "${encryption}")
    case "${enc_severity}" in
        CRITICAL) ((risk_score += RISK_FACTOR_CRITICAL * 3)) ;;
        HIGH) ((risk_score += RISK_FACTOR_HIGH * 3)) ;;
        MEDIUM) ((risk_score += RISK_FACTOR_MEDIUM * 3)) ;;
        LOW) ((risk_score += RISK_FACTOR_LOW * 3)) ;;
    esac
    
    # WPS vulnerability
    if [[ "${wps_enabled,,}" == "yes" ]]; then
        log_warn "WPS enabled on ${bssid}"
        ((risk_score += RISK_FACTOR_HIGH))
    fi
    
    # Hidden SSID (low impact but counts)
    if [[ "${hidden_ssid,,}" == "yes" ]]; then
        log_info "Hidden SSID detected"
        ((risk_score += RISK_FACTOR_LOW))
    fi
    
    # Device vulnerability check
    local device_risk=$(check_device_vulnerability "${bssid}")
    case "${device_risk}" in
        HIGH) ((risk_score += RISK_FACTOR_HIGH)) ;;
        MEDIUM) ((risk_score += RISK_FACTOR_MEDIUM)) ;;
        LOW) ((risk_score += RISK_FACTOR_LOW)) ;;
    esac
    
    # Signal strength (proximity risk)
    local signal_level=$(analyze_signal_strength "${signal}")
    case "${signal_level}" in
        EXCELLENT) ((risk_score += RISK_FACTOR_LOW * 2)) ;;
        GOOD) ((risk_score += RISK_FACTOR_LOW)) ;;
        FAIR) ((risk_score += 1)) ;;
    esac
    
    # Normalize score to 0-100
    if [[ ${risk_score} -gt 100 ]]; then
        risk_score=100
    fi
    
    echo "${risk_score}"
}

###############################################################################
# Generate security recommendations based on analysis
# Arguments: $1 - Network BSSID
###############################################################################
generate_recommendations() {
    local bssid="$1"
    
    declare -a recommendations=()
    
    # Get encryption for this network
    log_debug "Generating recommendations for ${bssid}"
    
    recommendations+=(
        "✓ Enable WPA3 if your router supports it"
        "✓ Use a strong, unique password (16+ characters with mixed case, numbers, symbols)"
        "✓ Disable WPS (WiFi Protected Setup)"
        "✓ Enable hidden SSID only as additional security layer, not primary defense"
        "✓ Keep router firmware updated"
        "✓ Disable remote management access"
        "✓ Change default admin credentials"
        "✓ Use strong encryption (CCMP for WPA2, native for WPA3)"
    )
    
    for rec in "${recommendations[@]}"; do
        echo "${rec}"
    done
}

###############################################################################
# Perform comprehensive security analysis
# Arguments: $1 - BSSID, $2 - ESSID, $3 - Encryption, $4 - Signal
###############################################################################
perform_security_analysis() {
    local bssid="$1"
    local essid="$2"
    local encryption="$3"
    local signal="${4:--50}"
    
    log_info "Analyzing network: ${essid} (${bssid})"
    
    # Create analysis report
    local report=$(cat <<EOF
╔════════════════════════════════════════════════════════════════╗
║            SECURITY ANALYSIS REPORT                           ║
║                                                                ║
║ Network: ${essid}
║ BSSID: ${bssid}
║ Encryption: ${encryption}
║ Signal: ${signal} dBm
║════════════════════════════════════════════════════════════════╣
EOF
    )
    
    # Encryption analysis
    local enc_severity=$(analyze_encryption "${encryption}")
    report+=$'\n'"║ Encryption Severity: ${enc_severity}"
    
    # Risk score
    local risk=$(calculate_risk_score "${bssid}" "${encryption}" "${signal}")
    report+=$'\n'"║ Overall Risk Score: ${risk}/100"
    
    report+=$'\n'"╚════════════════════════════════════════════════════════════════╝"
    
    echo "${report}"
}

###############################################################################
# Check network against common vulnerability patterns
# Arguments: $1 - Network configuration JSON
###############################################################################
check_common_vulnerabilities() {
    local config="$1"
    
    declare -a found_vulns=()
    
    # Extract values
    local bssid=$(echo "${config}" | grep -o '"bssid": "[^"]*"' | cut -d'"' -f4)
    local essid=$(echo "${config}" | grep -o '"essid": "[^"]*"' | cut -d'"' -f4)
    local encryption=$(echo "${config}" | grep -o '"encryption": "[^"]*"' | cut -d'"' -f4)
    
    log_info "Checking ${essid} for common vulnerabilities"
    
    # Check 1: Encryption
    if [[ "${encryption,,}" == "open" ]] || [[ -z "${encryption}" ]]; then
        found_vulns+=("NO_ENCRYPTION")
    elif [[ "${encryption,,}" == "wep" ]]; then
        found_vulns+=("WEP")
    fi
    
    # Check 2: Default SSID patterns
    if [[ "${essid,,}" =~ ^(default|admin|guest|netgear|linksys|dlink|tp-link|tplink|asus)$ ]]; then
        found_vulns+=("DEFAULT_CREDENTIALS")
    fi
    
    # Check 3: Hidden SSID (informational)
    if [[ -z "${essid}" ]] || [[ "${essid}" == "(Hidden Network)" ]]; then
        found_vulns+=("HIDDEN_SSID")
    fi
    
    # Output findings
    if [[ ${#found_vulns[@]} -gt 0 ]]; then
        log_warn "Found ${#found_vulns[@]} vulnerability patterns on ${bssid}"
        printf '%s\n' "${found_vulns[@]}"
    else
        log_info "No obvious vulnerabilities detected on ${bssid}"
        echo "NONE"
    fi
}

return 0 2>/dev/null || true
