#!/usr/bin/env bats

# Airgeddon Vulnerability Analyzer Tests
# Run with: bats tests/test_vulnerability_analyzer.bats

# Setup
setup() {
    export TEST_DIR="$(mktemp -d)"
    export LOG_FILE="${TEST_DIR}/test.log"
    export ENABLE_FILE_LOG="false"
    export ENABLE_CONSOLE_LOG="false"
    
    source "improvements/core/logging.sh"
    source "improvements/tools/vulnerability_analyzer.sh"
}

# Cleanup
teardown() {
    rm -rf "${TEST_DIR}"
}

################################################################################
# Test encryption analysis
################################################################################

@test "analyze_encryption identifies WEP as CRITICAL" {
    result=$(analyze_encryption "WEP")
    [ "${result}" = "CRITICAL" ]
}

@test "analyze_encryption identifies Open as CRITICAL" {
    result=$(analyze_encryption "Open")
    [ "${result}" = "CRITICAL" ]
}

@test "analyze_encryption identifies WPA2 as LOW" {
    result=$(analyze_encryption "WPA2")
    [ "${result}" = "LOW" ]
}

@test "analyze_encryption identifies WPA3 as NONE" {
    result=$(analyze_encryption "WPA3")
    [ "${result}" = "NONE" ]
}

@test "analyze_encryption identifies WPA-TKIP as HIGH" {
    result=$(analyze_encryption "WPA-TKIP")
    [ "${result}" = "HIGH" ]
}

@test "analyze_encryption is case-insensitive" {
    result1=$(analyze_encryption "wpa2")
    result2=$(analyze_encryption "WPA2")
    result3=$(analyze_encryption "WpA2")
    [ "${result1}" = "${result2}" ]
    [ "${result2}" = "${result3}" ]
}

@test "analyze_encryption handles mixed mode" {
    result=$(analyze_encryption "WPA2/WPA3")
    [ "${result}" = "LOW" ]
}

################################################################################
# Test password strength assessment
################################################################################

@test "assess_password_strength detects short passwords" {
    result=$(assess_password_strength "short")
    [ "${result}" = "HIGH" ]
}

@test "assess_password_strength detects weak passwords" {
    result=$(assess_password_strength "password123")
    [ "${result}" = "MEDIUM" ]
}

@test "assess_password_strength accepts strong passwords" {
    result=$(assess_password_strength "P@ssw0rd!Strong#2025")
    [ "${result}" = "LOW" ]
}

@test "assess_password_strength checks complexity" {
    result1=$(assess_password_strength "aaaaaaaa")  # Only lowercase
    result2=$(assess_password_strength "aA1!aA1!")  # All types
    
    # Lowercase only should rate worse
    [[ "${result1}" != "LOW" ]]
    [ "${result2}" = "LOW" ]
}

@test "assess_password_strength handles edge cases" {
    # Empty password
    result=$(assess_password_strength "")
    [ "${result}" = "HIGH" ]
    
    # Very short password
    result=$(assess_password_strength "x")
    [ "${result}" = "HIGH" ]
}

################################################################################
# Test signal strength analysis
################################################################################

@test "analyze_signal_strength identifies excellent signal" {
    result=$(analyze_signal_strength "-30")
    [ "${result}" = "EXCELLENT" ]
}

@test "analyze_signal_strength identifies good signal" {
    result=$(analyze_signal_strength "-50")
    [ "${result}" = "GOOD" ]
}

@test "analyze_signal_strength identifies fair signal" {
    result=$(analyze_signal_strength "-65")
    [ "${result}" = "FAIR" ]
}

@test "analyze_signal_strength identifies weak signal" {
    result=$(analyze_signal_strength "-80")
    [ "${result}" = "WEAK" ]
}

@test "analyze_signal_strength identifies very weak signal" {
    result=$(analyze_signal_strength "-95")
    [ "${result}" = "VERY_WEAK" ]
}

################################################################################
# Test device vulnerability checking
################################################################################

@test "check_device_vulnerability identifies TP-Link devices" {
    result=$(check_device_vulnerability "88:51:FB:AA:BB:CC")
    [ "${result}" = "HIGH" ]
}

@test "check_device_vulnerability handles unknown devices" {
    result=$(check_device_vulnerability "00:11:22:33:44:55")
    [ "${result}" = "NONE" ]
}

@test "check_device_vulnerability is case-insensitive" {
    result1=$(check_device_vulnerability "88:51:FB:aa:bb:cc")
    result2=$(check_device_vulnerability "88:51:FB:AA:BB:CC")
    [ "${result1}" = "${result2}" ]
}

################################################################################
# Test risk score calculation
################################################################################

@test "calculate_risk_score highest for WEP" {
    score_wep=$(calculate_risk_score "AA:BB:CC:DD:EE:FF" "WEP" "-50" "no" "no")
    score_wpa2=$(calculate_risk_score "AA:BB:CC:DD:EE:FF" "WPA2" "-50" "no" "no")
    
    ((score_wep > score_wpa2))
}

@test "calculate_risk_score increases with WPS enabled" {
    score_no_wps=$(calculate_risk_score "AA:BB:CC:DD:EE:FF" "WPA2" "-50" "no" "no")
    score_wps=$(calculate_risk_score "AA:BB:CC:DD:EE:FF" "WPA2" "-50" "yes" "no")
    
    ((score_wps > score_no_wps))
}

@test "calculate_risk_score is normalized to 0-100" {
    score=$(calculate_risk_score "AA:BB:CC:DD:EE:FF" "WEP" "-30" "yes" "yes")
    ((score <= 100))
    ((score >= 0))
}

@test "calculate_risk_score returns numeric value" {
    score=$(calculate_risk_score "AA:BB:CC:DD:EE:FF" "WPA2" "-50" "no" "no")
    [[ "${score}" =~ ^[0-9]+$ ]]
}

################################################################################
# Test vulnerability detection
################################################################################

@test "check_common_vulnerabilities detects open networks" {
    config='{"encryption": "Open"}'
    result=$(check_common_vulnerabilities "${config}")
    [[ "${result}" =~ "NO_ENCRYPTION" ]]
}

@test "check_common_vulnerabilities detects WEP" {
    config='{"encryption": "WEP"}'
    result=$(check_common_vulnerabilities "${config}")
    [[ "${result}" =~ "WEP" ]]
}

@test "check_common_vulnerabilities detects default SSIDs" {
    config='{"essid": "default", "encryption": "WPA2"}'
    result=$(check_common_vulnerabilities "${config}")
    [[ "${result}" =~ "DEFAULT_CREDENTIALS" ]]
}

@test "check_common_vulnerabilities detects hidden networks" {
    config='{"essid": "", "encryption": "WPA2"}'
    result=$(check_common_vulnerabilities "${config}")
    [[ "${result}" =~ "HIDDEN_SSID" ]]
}

@test "check_common_vulnerabilities returns NONE for secure networks" {
    config='{"bssid": "AA:BB:CC:DD:EE:FF", "essid": "SecureNetwork", "encryption": "WPA3"}'
    result=$(check_common_vulnerabilities "${config}")
    [ "${result}" = "NONE" ]
}

################################################################################
# Test recommendation generation
################################################################################

@test "generate_recommendations returns non-empty list" {
    result=$(generate_recommendations "AA:BB:CC:DD:EE:FF")
    [ -n "${result}" ]
}

@test "generate_recommendations includes WPA3 recommendation" {
    result=$(generate_recommendations "AA:BB:CC:DD:EE:FF")
    [[ "${result}" =~ "WPA3" ]]
}

@test "generate_recommendations includes password strength recommendation" {
    result=$(generate_recommendations "AA:BB:CC:DD:EE:FF")
    [[ "${result}" =~ "strong" || "${result}" =~ "Strong" ]]
}

################################################################################
# Test security analysis
################################################################################

@test "perform_security_analysis creates valid report" {
    result=$(perform_security_analysis "AA:BB:CC:DD:EE:FF" "TestNetwork" "WPA2" "-50")
    [[ "${result}" =~ "AA:BB:CC:DD:EE:FF" ]]
    [[ "${result}" =~ "TestNetwork" ]]
}

@test "perform_security_analysis includes risk score" {
    result=$(perform_security_analysis "AA:BB:CC:DD:EE:FF" "Test" "WPA2" "-50")
    [[ "${result}" =~ "Risk Score" ]]
}

################################################################################
# Test edge cases and error handling
################################################################################

@test "vulnerability functions handle empty input" {
    result=$(analyze_encryption "")
    [ -n "${result}" ]
    
    result=$(assess_password_strength "")
    [ -n "${result}" ]
}

@test "vulnerability analyzer handles special characters in ESSID" {
    config='{"essid": "Network@#$%&", "encryption": "WPA2"}'
    result=$(check_common_vulnerabilities "${config}")
    [ -n "${result}" ]
}

@test "risk scoring handles extreme values" {
    # Test with extreme signal strength
    score1=$(calculate_risk_score "AA:BB:CC:DD:EE:FF" "WPA2" "-200" "no" "no")
    score2=$(calculate_risk_score "AA:BB:CC:DD:EE:FF" "WPA2" "0" "no" "no")
    
    ((score1 >= 0 && score1 <= 100))
    ((score2 >= 0 && score2 <= 100))
}
